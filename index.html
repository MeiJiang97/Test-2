<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firestore æµ‹è¯•é¡µï¼ˆå…¨æ–°ï¼‰</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial; max-width: 720px; margin: 48px auto; padding: 0 16px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 6px; }
    .success { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
    .error { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }
    button { padding: 10px 16px; margin: 5px; background: #1976d2; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #125ea7; }
    input { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 6px; width: 260px; }
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .card { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-top: 16px; }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>ğŸŒ äº‘ç«¯æ•°æ®åŒæ­¥æµ‹è¯•</h1>
  <p>æ•°æ®ä¿å­˜åœ¨ Firestore äº‘ç«¯ï¼Œæ‰€æœ‰ç”¨æˆ·è®¿é—®éƒ½èƒ½çœ‹åˆ°ä¸€è‡´çš„æ•°æ®</p>

  <div id="status" class="status">å°šæœªå¼€å§‹æµ‹è¯•</div>

  <div class="card">
    <h3>ğŸ“± è®¾å¤‡ä¿¡æ¯</h3>
    <div id="deviceInfo" style="font-size: 14px; color: #666;">
      æ­£åœ¨æ£€æµ‹è®¾å¤‡ä¿¡æ¯...
    </div>
    <button id="btnTestConnection" style="margin-top: 10px; background: #ff9800;">ğŸ” æµ‹è¯•è¿æ¥</button>
  </div>

  <div class="card">
    <h3>ğŸ“ äº‘ç«¯æ•°æ®æ“ä½œ</h3>
    <div class="row">
      <input id="messageInput" type="text" placeholder="è¾“å…¥è¦ä¿å­˜åˆ°äº‘ç«¯çš„æ•°æ®" />
      <button id="btnAdd">ä¿å­˜åˆ°äº‘ç«¯</button>
      <button id="btnGet">ä»äº‘ç«¯è·å–</button>
      <button id="btnClear">æ¸…ç©ºäº‘ç«¯æ•°æ®</button>
    </div>
    <p style="font-size: 14px; color: #666; margin-top: 8px;">
      ğŸ’¡ æç¤ºï¼šæ•°æ®ä¼šå®æ—¶ä¿å­˜åˆ° Firestore äº‘ç«¯ï¼Œå…¶ä»–ç”¨æˆ·åˆ·æ–°é¡µé¢å°±èƒ½çœ‹åˆ°æœ€æ–°æ•°æ®
    </p>
  </div>

  <div id="dataDisplay" class="card">
    <h3>ğŸ“Š äº‘ç«¯æ•°æ® <span id="dataCount">(0)</span></h3>
    <div id="dataList">æš‚æ— æ•°æ®</div>
    <p style="font-size: 14px; color: #666; margin-top: 8px;">
      ğŸ”„ æ•°æ®ä¼šè‡ªåŠ¨ä»äº‘ç«¯åŒæ­¥ï¼Œæ”¯æŒå¤šäººåŒæ—¶æŸ¥çœ‹
    </p>
  </div>

  <script type="module">
    import { app, db } from './firebase-config.js';
    import { 
      collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const statusEl = document.getElementById('status');
    const inputEl = document.getElementById('messageInput');
    const dataListEl = document.getElementById('dataList');
    const dataCountEl = document.getElementById('dataCount');

    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
    function showDeviceInfo() {
      const deviceInfo = document.getElementById('deviceInfo');
      if (deviceInfo) {
        const info = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          cookieEnabled: navigator.cookieEnabled,
          onLine: navigator.onLine,
          connection: navigator.connection ? navigator.connection.effectiveType : 'unknown',
          timestamp: new Date().toISOString()
        };
        
        deviceInfo.innerHTML = `
          <div><strong>è®¾å¤‡å¹³å°:</strong> ${info.platform}</div>
          <div><strong>æµè§ˆå™¨:</strong> ${info.userAgent.substring(0, 100)}...</div>
          <div><strong>è¯­è¨€:</strong> ${info.language}</div>
          <div><strong>Cookie:</strong> ${info.cookieEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</div>
          <div><strong>ç½‘ç»œçŠ¶æ€:</strong> ${info.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
          <div><strong>è¿æ¥ç±»å‹:</strong> ${info.connection}</div>
          <div><strong>æ£€æµ‹æ—¶é—´:</strong> ${new Date(info.timestamp).toLocaleString()}</div>
        `;
      }
    }

    // æµ‹è¯•è¿æ¥åŠŸèƒ½
    async function testConnection() {
      try {
        setStatus('ğŸ” æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
        console.log('ğŸ” å¼€å§‹æµ‹è¯•è¿æ¥...');
        
        // æµ‹è¯•åŸºæœ¬è¿æ¥
        const testQuery = await getDocs(collection(db, 'test'));
        console.log('âœ… åŸºæœ¬è¿æ¥æµ‹è¯•é€šè¿‡ï¼ŒæŸ¥è¯¢ç»“æœ:', testQuery.size, 'æ¡');
        
        // æµ‹è¯•å†™å…¥æƒé™
        setStatus('ğŸ”„ æµ‹è¯•å†™å…¥æƒé™...', 'info');
        const testDoc = await addDoc(collection(db, 'test'), {
          message: 'è¿æ¥æµ‹è¯• - ' + new Date().toISOString(),
          timestamp: new Date().toISOString(),
          test: true
        });
        console.log('âœ… å†™å…¥æƒé™æµ‹è¯•é€šè¿‡ï¼Œåˆ›å»ºæ–‡æ¡£:', testDoc.id);
        
        // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ–‡æ¡£åˆ›å»ºå®Œæˆ
        setStatus('ğŸ”„ ç­‰å¾…æ–‡æ¡£åˆ›å»ºå®Œæˆ...', 'info');
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // ç«‹å³åˆ é™¤æµ‹è¯•æ–‡æ¡£
        setStatus('ğŸ”„ æµ‹è¯•åˆ é™¤æƒé™...', 'info');
        await deleteDoc(doc(db, 'test', testDoc.id));
        console.log('âœ… åˆ é™¤æƒé™æµ‹è¯•é€šè¿‡');
        
        // å†æ¬¡ç­‰å¾…ç¡®ä¿åˆ é™¤å®Œæˆ
        setStatus('ğŸ”„ ç­‰å¾…åˆ é™¤æ“ä½œå®Œæˆ...', 'info');
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        setStatus('âœ… è¿æ¥æµ‹è¯•å®Œæˆï¼šè¯»å–ã€å†™å…¥ã€åˆ é™¤æƒé™éƒ½æ­£å¸¸', 'success');
        
        // é‡æ–°è·å–æ•°æ®
        await onGet();
        
      } catch (e) {
        console.error('âŒ è¿æ¥æµ‹è¯•å¤±è´¥:', e);
        setStatus('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + e.message, 'error');
      }
    }

    async function smokeTest() {
      try {
        setStatus('ğŸ”„ æ­£åœ¨è¿æ¥ Firestore äº‘ç«¯...', 'info');
        
        // æµ‹è¯•äº‘ç«¯è¿æ¥
        const testQuery = await getDocs(collection(db, 'test')); 
        console.log('âœ… è¿æ¥æˆåŠŸï¼Œæµ‹è¯•æŸ¥è¯¢ç»“æœ:', testQuery.size, 'æ¡æ•°æ®');
        
        setStatus('âœ… Firestore äº‘ç«¯è¿æ¥æˆåŠŸï¼Œæ•°æ®å°†å®æ—¶åŒæ­¥', 'success');
        
        // è‡ªåŠ¨è·å–äº‘ç«¯æ•°æ®
        await onGet();
      } catch (e) {
        console.error('âŒ è¿æ¥å¤±è´¥è¯¦ç»†é”™è¯¯:', e);
        console.error('é”™è¯¯ä»£ç :', e.code);
        console.error('é”™è¯¯æ¶ˆæ¯:', e.message);
        console.error('é”™è¯¯å †æ ˆ:', e.stack);
        
        let errorMsg = 'âŒ Firestore äº‘ç«¯è¿æ¥å¤±è´¥: ' + e.message;
        if (e.code) errorMsg += ` (ä»£ç : ${e.code})`;
        
        setStatus(errorMsg, 'error');
      }
    }

    async function onAdd() {
      const val = (inputEl.value || '').trim();
      if (!val) return;
      try {
        await addDoc(collection(db, 'test'), {
          message: val,
          createdAt: serverTimestamp(),
          userAgent: navigator.userAgent.substring(0, 50) + '...',
          timestamp: new Date().toISOString()
        });
        inputEl.value = '';
        setStatus(`âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯: ${val}`, 'success');
        await onGet();
      } catch (e) {
        setStatus('âŒ ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥: ' + e.message, 'error');
      }
    }

    async function onGet() {
      try {
        setStatus('ğŸ”„ æ­£åœ¨ä»äº‘ç«¯è·å–æ•°æ®...', 'info');
        console.log('ğŸ”„ å¼€å§‹æŸ¥è¯¢ test é›†åˆ...');
        
        const snap = await getDocs(collection(db, 'test'));
        console.log('ğŸ“Š æŸ¥è¯¢ç»“æœ:', snap.size, 'æ¡æ•°æ®');
        console.log('ğŸ“Š æŸ¥è¯¢è¯¦æƒ…:', snap);
        
        if (snap.empty) {
          console.log('ğŸ“­ é›†åˆä¸ºç©ºï¼Œæ²¡æœ‰æ•°æ®');
          dataListEl.textContent = 'æš‚æ— æ•°æ®';
          dataCountEl.textContent = '(0)';
          setStatus('ğŸ“­ äº‘ç«¯æš‚æ— æ•°æ®ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®', 'info');
          return;
        }
        
        let html = '';
        snap.forEach(d => {
          const data = d.data();
          console.log('ğŸ“„ æ–‡æ¡£æ•°æ®:', d.id, data);
          const time = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'åˆšåˆš';
          html += `<div style="padding:8px; border:1px solid #eee; border-radius:4px; margin:8px 0; background:white;">
            <div><strong>${data.message || ''}</strong></div>
            <div style="font-size:12px; color:#666; margin-top:4px;">
              ğŸ“… ${time} | ğŸ“± ${data.userAgent || 'æœªçŸ¥è®¾å¤‡'} | ğŸ†” <code>${d.id}</code>
            </div>
          </div>`;
        });
        
        dataListEl.innerHTML = html;
        dataCountEl.textContent = `(${snap.size})`;
        setStatus(`âœ… å·²ä»äº‘ç«¯è·å– ${snap.size} æ¡æ•°æ®`, 'success');
        console.log('âœ… æ•°æ®è·å–å®Œæˆï¼Œå·²æ›´æ–°é¡µé¢');
        
      } catch (e) {
        console.error('âŒ è·å–æ•°æ®å¤±è´¥:', e);
        console.error('é”™è¯¯ä»£ç :', e.code);
        console.error('é”™è¯¯æ¶ˆæ¯:', e.message);
        setStatus('âŒ ä»äº‘ç«¯è·å–å¤±è´¥: ' + e.message, 'error');
      }
    }

    async function onClear() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºäº‘ç«¯æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
      
      try {
        const snap = await getDocs(collection(db, 'test'));
        const deletions = [];
        snap.forEach(d => deletions.push(deleteDoc(doc(db, 'test', d.id))));
        await Promise.all(deletions);
        setStatus(`âœ… å·²æ¸…ç©ºäº‘ç«¯ ${snap.size} æ¡æ•°æ®`, 'success');
        await onGet();
      } catch (e) {
        setStatus('âŒ æ¸…ç©ºäº‘ç«¯æ•°æ®å¤±è´¥: ' + e.message, 'error');
      }
    }

    document.getElementById('btnAdd').addEventListener('click', onAdd);
    document.getElementById('btnGet').addEventListener('click', onGet);
    document.getElementById('btnClear').addEventListener('click', onClear);
    document.getElementById('btnTestConnection').addEventListener('click', testConnection);

    smokeTest();
    
    // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
    showDeviceInfo();
  </script>
</body>
</html>


