<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firestore 测试页（全新）</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial; max-width: 720px; margin: 48px auto; padding: 0 16px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 6px; }
    .success { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
    .error { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }
    button { padding: 10px 16px; margin: 5px; background: #1976d2; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #125ea7; }
    input { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 6px; width: 260px; }
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .card { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-top: 16px; }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>🌐 云端数据同步测试</h1>
  <p>数据保存在 Firestore 云端，所有用户访问都能看到一致的数据</p>

  <div id="status" class="status">尚未开始测试</div>

  <div class="card">
    <h3>📝 云端数据操作</h3>
    <div class="row">
      <input id="messageInput" type="text" placeholder="输入要保存到云端的数据" />
      <button id="btnAdd">保存到云端</button>
      <button id="btnGet">从云端获取</button>
      <button id="btnClear">清空云端数据</button>
    </div>
    <p style="font-size: 14px; color: #666; margin-top: 8px;">
      💡 提示：数据会实时保存到 Firestore 云端，其他用户刷新页面就能看到最新数据
    </p>
  </div>

  <div id="dataDisplay" class="card">
    <h3>📊 云端数据 <span id="dataCount">(0)</span></h3>
    <div id="dataList">暂无数据</div>
    <p style="font-size: 14px; color: #666; margin-top: 8px;">
      🔄 数据会自动从云端同步，支持多人同时查看
    </p>
  </div>

  <script type="module">
    import { app, db } from './firebase-config.js';
    import { 
      collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const statusEl = document.getElementById('status');
    const inputEl = document.getElementById('messageInput');
    const dataListEl = document.getElementById('dataList');

    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    async function smokeTest() {
      try {
        // 测试云端连接
        await getDocs(collection(db, 'test')); 
        setStatus('✅ Firestore 云端连接成功，数据将实时同步', 'success');
        // 自动获取云端数据
        await onGet();
      } catch (e) {
        setStatus('❌ Firestore 云端连接失败: ' + e.message, 'error');
        console.error(e);
      }
    }

    async function onAdd() {
      const val = (inputEl.value || '').trim();
      if (!val) return;
      try {
        await addDoc(collection(db, 'test'), {
          message: val,
          createdAt: serverTimestamp(),
          userAgent: navigator.userAgent.substring(0, 50) + '...',
          timestamp: new Date().toISOString()
        });
        inputEl.value = '';
        setStatus(`✅ 数据已保存到云端: ${val}`, 'success');
        await onGet();
      } catch (e) {
        setStatus('❌ 保存到云端失败: ' + e.message, 'error');
      }
    }

    async function onGet() {
      try {
        const snap = await getDocs(collection(db, 'test'));
        if (snap.empty) {
          dataListEl.textContent = '暂无数据';
          dataCountEl.textContent = '(0)';
          return;
        }
        let html = '';
        snap.forEach(d => {
          const data = d.data();
          const time = data.timestamp ? new Date(data.timestamp).toLocaleString() : '刚刚';
          html += `<div style="padding:8px; border:1px solid #eee; border-radius:4px; margin:8px 0; background:white;">
            <div><strong>${data.message || ''}</strong></div>
            <div style="font-size:12px; color:#666; margin-top:4px;">
              📅 ${time} | 📱 ${data.userAgent || '未知设备'} | 🆔 <code>${d.id}</code>
            </div>
          </div>`;
        });
        dataListEl.innerHTML = html;
        dataCountEl.textContent = `(${snap.size})`;
        setStatus(`✅ 已从云端获取 ${snap.size} 条数据`, 'success');
      } catch (e) {
        setStatus('❌ 从云端获取失败: ' + e.message, 'error');
      }
    }

    async function onClear() {
      if (!confirm('确定要清空云端所有数据吗？此操作不可恢复！')) return;
      
      try {
        const snap = await getDocs(collection(db, 'test'));
        const deletions = [];
        snap.forEach(d => deletions.push(deleteDoc(doc(db, 'test', d.id))));
        await Promise.all(deletions);
        setStatus(`✅ 已清空云端 ${snap.size} 条数据`, 'success');
        await onGet();
      } catch (e) {
        setStatus('❌ 清空云端数据失败: ' + e.message, 'error');
      }
    }

    document.getElementById('btnAdd').addEventListener('click', onAdd);
    document.getElementById('btnGet').addEventListener('click', onGet);
    document.getElementById('btnClear').addEventListener('click', onClear);

    smokeTest();
  </script>
</body>
</html>


