<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firestore æµ‹è¯•é¡µï¼ˆå…¨æ–°ï¼‰</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial; max-width: 720px; margin: 48px auto; padding: 0 16px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 6px; }
    .success { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
    .error { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }
    button { padding: 10px 16px; margin: 5px; background: #1976d2; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #125ea7; }
    input { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 6px; width: 260px; }
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .card { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-top: 16px; }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>ğŸŒ äº‘ç«¯æ•°æ®åŒæ­¥æµ‹è¯•</h1>
  <p>æ•°æ®ä¿å­˜åœ¨ Firestore äº‘ç«¯ï¼Œæ‰€æœ‰ç”¨æˆ·è®¿é—®éƒ½èƒ½çœ‹åˆ°ä¸€è‡´çš„æ•°æ®</p>

  <div id="status" class="status">å°šæœªå¼€å§‹æµ‹è¯•</div>

  <div class="card">
    <h3>ğŸ“ äº‘ç«¯æ•°æ®æ“ä½œ</h3>
    <div class="row">
      <input id="messageInput" type="text" placeholder="è¾“å…¥è¦ä¿å­˜åˆ°äº‘ç«¯çš„æ•°æ®" />
      <button id="btnAdd">ä¿å­˜åˆ°äº‘ç«¯</button>
      <button id="btnGet">ä»äº‘ç«¯è·å–</button>
      <button id="btnClear">æ¸…ç©ºäº‘ç«¯æ•°æ®</button>
    </div>
    <p style="font-size: 14px; color: #666; margin-top: 8px;">
      ğŸ’¡ æç¤ºï¼šæ•°æ®ä¼šå®æ—¶ä¿å­˜åˆ° Firestore äº‘ç«¯ï¼Œå…¶ä»–ç”¨æˆ·åˆ·æ–°é¡µé¢å°±èƒ½çœ‹åˆ°æœ€æ–°æ•°æ®
    </p>
  </div>

  <div id="dataDisplay" class="card">
    <h3>ğŸ“Š äº‘ç«¯æ•°æ® <span id="dataCount">(0)</span></h3>
    <div id="dataList">æš‚æ— æ•°æ®</div>
    <p style="font-size: 14px; color: #666; margin-top: 8px;">
      ğŸ”„ æ•°æ®ä¼šè‡ªåŠ¨ä»äº‘ç«¯åŒæ­¥ï¼Œæ”¯æŒå¤šäººåŒæ—¶æŸ¥çœ‹
    </p>
  </div>

  <script type="module">
    import { app, db } from './firebase-config.js';
    import { 
      collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const statusEl = document.getElementById('status');
    const inputEl = document.getElementById('messageInput');
    const dataListEl = document.getElementById('dataList');

    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    async function smokeTest() {
      try {
        // æµ‹è¯•äº‘ç«¯è¿æ¥
        await getDocs(collection(db, 'test')); 
        setStatus('âœ… Firestore äº‘ç«¯è¿æ¥æˆåŠŸï¼Œæ•°æ®å°†å®æ—¶åŒæ­¥', 'success');
        // è‡ªåŠ¨è·å–äº‘ç«¯æ•°æ®
        await onGet();
      } catch (e) {
        setStatus('âŒ Firestore äº‘ç«¯è¿æ¥å¤±è´¥: ' + e.message, 'error');
        console.error(e);
      }
    }

    async function onAdd() {
      const val = (inputEl.value || '').trim();
      if (!val) return;
      try {
        await addDoc(collection(db, 'test'), {
          message: val,
          createdAt: serverTimestamp(),
          userAgent: navigator.userAgent.substring(0, 50) + '...',
          timestamp: new Date().toISOString()
        });
        inputEl.value = '';
        setStatus(`âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯: ${val}`, 'success');
        await onGet();
      } catch (e) {
        setStatus('âŒ ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥: ' + e.message, 'error');
      }
    }

    async function onGet() {
      try {
        const snap = await getDocs(collection(db, 'test'));
        if (snap.empty) {
          dataListEl.textContent = 'æš‚æ— æ•°æ®';
          dataCountEl.textContent = '(0)';
          return;
        }
        let html = '';
        snap.forEach(d => {
          const data = d.data();
          const time = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'åˆšåˆš';
          html += `<div style="padding:8px; border:1px solid #eee; border-radius:4px; margin:8px 0; background:white;">
            <div><strong>${data.message || ''}</strong></div>
            <div style="font-size:12px; color:#666; margin-top:4px;">
              ğŸ“… ${time} | ğŸ“± ${data.userAgent || 'æœªçŸ¥è®¾å¤‡'} | ğŸ†” <code>${d.id}</code>
            </div>
          </div>`;
        });
        dataListEl.innerHTML = html;
        dataCountEl.textContent = `(${snap.size})`;
        setStatus(`âœ… å·²ä»äº‘ç«¯è·å– ${snap.size} æ¡æ•°æ®`, 'success');
      } catch (e) {
        setStatus('âŒ ä»äº‘ç«¯è·å–å¤±è´¥: ' + e.message, 'error');
      }
    }

    async function onClear() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºäº‘ç«¯æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
      
      try {
        const snap = await getDocs(collection(db, 'test'));
        const deletions = [];
        snap.forEach(d => deletions.push(deleteDoc(doc(db, 'test', d.id))));
        await Promise.all(deletions);
        setStatus(`âœ… å·²æ¸…ç©ºäº‘ç«¯ ${snap.size} æ¡æ•°æ®`, 'success');
        await onGet();
      } catch (e) {
        setStatus('âŒ æ¸…ç©ºäº‘ç«¯æ•°æ®å¤±è´¥: ' + e.message, 'error');
      }
    }

    document.getElementById('btnAdd').addEventListener('click', onAdd);
    document.getElementById('btnGet').addEventListener('click', onGet);
    document.getElementById('btnClear').addEventListener('click', onClear);

    smokeTest();
  </script>
</body>
</html>


